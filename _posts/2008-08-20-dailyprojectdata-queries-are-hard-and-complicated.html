---
layout: post
title: "DailyProjectData Queries are hard and complicated"
date: 2008-08-20
comments: false
---

<div class='post'>
I've been spending my night time internet time working on SQL queries that will return records with the DailyProjectData (DPD) information conforming to the <a href="http://code.google.com/p/hackystat-analysis-dailyprojectdata/wiki/RestApiSpecification">DPD REST API</a>.  It's been a pretty rough road just getting the queries to work correctly.  Now that I have it working, I have to work on the performance of the queries.   I know that I wrote a query that performs badly, but just getting it to work was pretty tough since I'm a noob with SQL.<br /><br />Here is the Code Issue Query that I wrote that returns the amount of code issues for all tools between a specific timeframe for all data.  If you want to get the data for a specific project, there needs to be a sensordata.resource clause in the query.  The records that are returned have columns with the type of code issue, the latest runtime, tool, and the code issue total:<br /><br /><br />SELECT issue_type, tool_runtime, tool, sum(cast(issue_count as integer)) from (<br /><br /><span style="font-weight: bold;">-- This sub query gets all of the records without grouping the issue counts</span><br />SELECT sensordata_properties.key AS issue_type, sensordata.runtime<br />AS tool_runtime, sensordata.tool, value AS issue_count FROM "sensordata"<br />INNER JOIN sensordata_properties ON (sensordata_properties.sensordata_id = sensordata.id) WHERE (sdt_id = (select id FROM SensorDataType where name ~* 'CodeIssue')<br />AND  tstamp > '2008-08-012T00:00:00.000' AND tstamp < '2008-08-13T00:00:00' AND sensordata_properties.key LIKE 'Type_%' AND sensordata.runtime IN (   <span style="font-weight: bold;"><br /><br />-- This subquery gets the latest runtime</span><br />SELECT latest_runtime FROM (select max(sensordata.runtime)  AS latest_runtime, sensordata.tool FROM "sensordata" INNER JOIN sensordata_properties<br />ON (sensordata_properties.sensordata_id = sensordata.id) WHERE (sdt_id = (select id<br />FROM SensorDataType WHERE name ~* 'CodeIssue')  AND tstamp > '2008-08-012T00:00:00.000' AND tstamp < '2008-08-13T00:00:00' AND sensordata_properties.key LIKE 'Type_%')  GROUP BY tool)  AS latest_runtime_query)) <br /><br />GROUP BY sensordata.tool, runtime, sensordata_properties.key, value ORDER BY key) AS issue_sum_query GROUP BY issue_type, tool_runtime, tool ORDER BY issue_type  <br /><br />Phew.  Thats a big query.  I need to figure out how to refactor the query so I don't repeat the same sub query twice.  These queries are currently being using in rails with the <span style="font-weight: bold;">find_by_sql</span> method, but James told me to check out the <span style="font-weight: bold;">:includes</span> directive because it is very powerful and can handle what I'm trying to do without using specific SQL<br /><br />The good news is that our DPD service implementation is compatible with the Wicket ProjectBrowser that the CSDL team is working on. Right now we can retrieve the raw SensorData and Build DPD summaries.  Hopefully, I'll be able to get the rest of DPD queries working and we can start using the ProjectBrowser at work.</div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>aaron</div>
<div class='content'>
woah... your query is big. anyway, i took a stab at refactoring it and here is what i got: <BR/><BR/>SELECT sensordata_properties.key AS issue_type, <BR/>sensordata.runtime AS tool_runtime, <BR/>sensordata.tool, <BR/>count(*)<BR/>FROM sensordata, sensordata_properties, <BR/>(select max(sensordata.runtime) AS latest_runtime, sensordata.tool <BR/>FROM sensordata, sensordatatype <BR/>WHERE sensordatatype.id = sensordata.sdt_id<BR/>and sensordatatype.name = &#39;CodeIssue&#39; <BR/>AND tstamp &gt; &#39;2008-08-12T00:00:00.000&#39; <BR/>AND tstamp &lt; &#39;2008-08-13T00:00:00&#39; <BR/>GROUP BY tool) as latest_runtime<BR/>where sensordata.id = sensordata_properties.sensordata_id <BR/>and sensordata.runtime = latest_runtime.latest_runtime <BR/>GROUP BY sensordata.tool, runtime, sensordata_properties.key, value ORDER BY key<BR/><BR/>this query is way faster. actually running over VPN isn&#39;t a good test though. somethings to note: <BR/>1) you probably want to keep the subqueries nice and small and quick. i didn&#39;t see the need of joining up the sensordata_properties in your most inner subquery. so, i took it out. that made it go a lot faster already. <BR/>2) i don&#39;t really like the inner join syntax (oracle handles joins way better syntactically). your inner joins can be rewritten using the syntax that i used. i think it makes it a lot clearer. <BR/>3) i just realized that the sensordata_properties.key field isn&#39;t index. it probably should be. <BR/><BR/>anyway, we can talk more about the query later.</div>
</div>
</div>
